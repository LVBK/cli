'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

exports.getPlatformRootDir = getPlatformRootDir;
exports.getPlatformExtensionsDir = getPlatformExtensionsDir;
exports.createPlatformConfig = createPlatformConfig;
exports.getPlatformConfig = getPlatformConfig;
exports.setPlatformConfig = setPlatformConfig;
exports.configurePlatform = configurePlatform;
exports.fixPlatform = fixPlatform;
exports.downloadApp = downloadApp;
exports.addToExtensionsJs = addToExtensionsJs;
exports.linkLocalExtension = linkLocalExtension;

var _url = require('url');

var _url2 = _interopRequireDefault(_url);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _replaceInFile = require('replace-in-file');

var _replaceInFile2 = _interopRequireDefault(_replaceInFile);

var _appManager = require('../clients/app-manager');

var appManager = _interopRequireWildcard(_appManager);

var _authService = require('../clients/auth-service');

var authService = _interopRequireWildcard(_authService);

var _decompress = require('./decompress');

var _decompress2 = _interopRequireDefault(_decompress);

var _services = require('../../config/services');

var _services2 = _interopRequireDefault(_services);

var _data = require('./data');

var _npm = require('./npm');

var npm = _interopRequireWildcard(_npm);

var _yarn = require('./yarn');

var _reactNative = require('./react-native');

var reactNative = _interopRequireWildcard(_reactNative);

var _analytics = require('./analytics');

var analytics = _interopRequireWildcard(_analytics);

var _fsExtra = require('fs-extra');

var _commandExists = require('./command-exists');

var _commandExists2 = _interopRequireDefault(_commandExists);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

async function isPlatformDirectory(dir) {
  const { name } = (await (0, _data.readJsonFile)(_path2.default.join(dir, 'package.json'))) || {};

  // platform package was renamed with Platform release v1.1.10
  return name === '@shoutem/mobile-app' || name === '@shoutem/platform';
}

async function getPlatformRootDir(dir = process.cwd(), { shouldThrow = true } = {}) {
  if (await isPlatformDirectory(dir)) {
    return dir;
  }

  const parentDir = _path2.default.join(dir, '..');

  if (parentDir === dir) {
    if (shouldThrow) {
      throw new Error('Not a platform directory');
    } else {
      return null;
    }
  }
  return await getPlatformRootDir(parentDir, { shouldThrow });
}

async function getPlatformExtensionsDir(dir = null) {
  return _path2.default.join(dir || (await getPlatformRootDir()), 'extensions');
}

async function createPlatformConfig(platformDir, opts) {
  const configTemplate = await (0, _fsExtra.readJson)(_path2.default.join(platformDir, 'config.template.json'));

  let authorization;
  try {
    authorization = await authService.createAppAccessToken(opts.appId, (await authService.getRefreshToken()));
  } catch (err) {
    if (err.code === 401 || err.code === 403) {
      err.message = 'Not authorized to create application token. You must log in again using `shoutem login` command.';
    }
    throw err;
  }

  return _extends({}, configTemplate, opts, {
    serverApiEndpoint: _url2.default.parse(_services2.default.appManager).hostname,
    legacyApiEndpoint: _url2.default.parse(_services2.default.legacyService).hostname,
    authorization,
    configurationFilePath: 'config.json'
  });
}

async function getPlatformConfig(platformDir = null) {
  return await (0, _fsExtra.readJson)(_path2.default.join(platformDir || (await getPlatformRootDir()), 'config.json'));
}

async function setPlatformConfig(platformDir, mobileConfig) {
  await (0, _data.writeJsonFile)(mobileConfig, _path2.default.join(platformDir, 'config.json'));
}

async function configurePlatform(platformDir) {
  await (0, _yarn.ensureYarnInstalled)();
  await reactNative.ensureInstalled();
  if (process.platform === 'darwin' && !(await (0, _commandExists2.default)('pod'))) {
    throw new Error('Missing `pods` command. Please install cocoapods and run `shoutem configure` in the ' + `${platformDir} directory`);
  }

  if (!(await getPlatformConfig(platformDir))) {
    throw new Error('Missing config.json file');
  }

  await npm.install(_path2.default.join(platformDir, 'scripts'));
  await npm.run(platformDir, 'configure');
}

async function fixPlatform(platformDir, appId) {
  const appBuilderPath = _path2.default.join(platformDir, 'scripts', 'classes', 'app-builder.js');

  if (process.platform === 'win32') {
    try {
      await (0, _replaceInFile2.default)({
        files: appBuilderPath,
        from: './gradlew',
        to: 'gradlew'
      });
    } catch (err) {
      console.log('WARN: Could not rename ./gradle to gradle');
    }

    try {
      await (0, _replaceInFile2.default)({
        files: appBuilderPath,
        from: "const apkPath = path.join('android', 'app', 'build', 'outputs', 'apk');",
        to: `const apkPath = path.join('c:/', '${appId}', 'tmp', 'ShoutemApp', 'app', 'outputs', 'apk');`
      });
    } catch (err) {
      console.log('WARN: Could not adapt client for c:\\tmp build directory');
    }

    try {
      await (0, _replaceInFile2.default)({
        files: _path2.default.join(platformDir, 'android', 'build.gradle'),
        from: '//<CLI> buildDir = "C:/tmp/',
        to: `buildDir = "C:/tmp/${appId}/`
      });
    } catch (err) {
      console.log('WARN: Could not set the tmp build directory for android app');
    }
  }
}

async function downloadApp(appId, destinationDir, options = {}) {
  analytics.setAppId(appId);

  const versionCheck = options.versionCheck || (() => {});

  const { mobileAppVersion } = await appManager.getApplicationPlatform(appId);
  await versionCheck(mobileAppVersion);

  await pullPlatform(mobileAppVersion, destinationDir, options);

  if (!(await (0, _fsExtra.pathExists)(destinationDir))) {
    throw new Error('Platform code could not be downloaded from github. Make sure that platform is setup correctly.');
  }
}

async function pullPlatform(version, destination, options) {
  const url = `${_services2.default.mobileAppUrl}/archive/v${version}.tar.gz`;
  await (0, _decompress2.default)(url, destination, _extends({}, options, { strip: 1, useCache: options.useCache }));
}

async function addToExtensionsJs(platformDir, extensionPath) {
  const { name } = await npm.getPackageJson(_path2.default.join(extensionPath, 'app'));

  const extensionsJsPath = _path2.default.join(platformDir, 'extensions.js');

  let extensionsJsData = await (0, _fsExtra.readFile)(extensionsJsPath, 'utf8');

  if (_lodash2.default.includes(extensionsJsData, `'${name}'`)) {
    return;
  }

  extensionsJsData = extensionsJsData.replace('};', `'${name}': require('${name}'),`);
  extensionsJsData += '  };\n';

  await (0, _fsExtra.writeFile)(extensionsJsPath, extensionsJsData);
}

async function linkLocalExtension(platformDir, extensionPath) {
  await npm.addLocalDependency(platformDir, _path2.default.join(extensionPath, 'app'));
  await npm.linkLocalDependencies(platformDir);
  await npm.install(platformDir);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2aWNlcy9wbGF0Zm9ybS5qcyJdLCJuYW1lcyI6WyJnZXRQbGF0Zm9ybVJvb3REaXIiLCJnZXRQbGF0Zm9ybUV4dGVuc2lvbnNEaXIiLCJjcmVhdGVQbGF0Zm9ybUNvbmZpZyIsImdldFBsYXRmb3JtQ29uZmlnIiwic2V0UGxhdGZvcm1Db25maWciLCJjb25maWd1cmVQbGF0Zm9ybSIsImZpeFBsYXRmb3JtIiwiZG93bmxvYWRBcHAiLCJhZGRUb0V4dGVuc2lvbnNKcyIsImxpbmtMb2NhbEV4dGVuc2lvbiIsImFwcE1hbmFnZXIiLCJhdXRoU2VydmljZSIsIm5wbSIsInJlYWN0TmF0aXZlIiwiYW5hbHl0aWNzIiwiaXNQbGF0Zm9ybURpcmVjdG9yeSIsImRpciIsIm5hbWUiLCJwYXRoIiwiam9pbiIsInByb2Nlc3MiLCJjd2QiLCJzaG91bGRUaHJvdyIsInBhcmVudERpciIsIkVycm9yIiwicGxhdGZvcm1EaXIiLCJvcHRzIiwiY29uZmlnVGVtcGxhdGUiLCJhdXRob3JpemF0aW9uIiwiY3JlYXRlQXBwQWNjZXNzVG9rZW4iLCJhcHBJZCIsImdldFJlZnJlc2hUb2tlbiIsImVyciIsImNvZGUiLCJtZXNzYWdlIiwic2VydmVyQXBpRW5kcG9pbnQiLCJ1cmwiLCJwYXJzZSIsImNsaVVybHMiLCJob3N0bmFtZSIsImxlZ2FjeUFwaUVuZHBvaW50IiwibGVnYWN5U2VydmljZSIsImNvbmZpZ3VyYXRpb25GaWxlUGF0aCIsIm1vYmlsZUNvbmZpZyIsImVuc3VyZUluc3RhbGxlZCIsInBsYXRmb3JtIiwiaW5zdGFsbCIsInJ1biIsImFwcEJ1aWxkZXJQYXRoIiwiZmlsZXMiLCJmcm9tIiwidG8iLCJjb25zb2xlIiwibG9nIiwiZGVzdGluYXRpb25EaXIiLCJvcHRpb25zIiwic2V0QXBwSWQiLCJ2ZXJzaW9uQ2hlY2siLCJtb2JpbGVBcHBWZXJzaW9uIiwiZ2V0QXBwbGljYXRpb25QbGF0Zm9ybSIsInB1bGxQbGF0Zm9ybSIsInZlcnNpb24iLCJkZXN0aW5hdGlvbiIsIm1vYmlsZUFwcFVybCIsInN0cmlwIiwidXNlQ2FjaGUiLCJleHRlbnNpb25QYXRoIiwiZ2V0UGFja2FnZUpzb24iLCJleHRlbnNpb25zSnNQYXRoIiwiZXh0ZW5zaW9uc0pzRGF0YSIsIl8iLCJpbmNsdWRlcyIsInJlcGxhY2UiLCJhZGRMb2NhbERlcGVuZGVuY3kiLCJsaW5rTG9jYWxEZXBlbmRlbmNpZXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O1FBd0JzQkEsa0IsR0FBQUEsa0I7UUFpQkFDLHdCLEdBQUFBLHdCO1FBSUFDLG9CLEdBQUFBLG9CO1FBdUJBQyxpQixHQUFBQSxpQjtRQUlBQyxpQixHQUFBQSxpQjtRQUlBQyxpQixHQUFBQSxpQjtRQWdCQUMsVyxHQUFBQSxXO1FBb0NBQyxXLEdBQUFBLFc7UUFvQkFDLGlCLEdBQUFBLGlCO1FBaUJBQyxrQixHQUFBQSxrQjs7QUFyS3RCOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0lBQVlDLFU7O0FBQ1o7O0lBQVlDLFc7O0FBQ1o7Ozs7QUFDQTs7OztBQUNBOztBQUNBOztJQUFZQyxHOztBQUNaOztBQUNBOztJQUFZQyxXOztBQUNaOztJQUFZQyxTOztBQUNaOztBQUNBOzs7Ozs7OztBQUdBLGVBQWVDLG1CQUFmLENBQW1DQyxHQUFuQyxFQUF3QztBQUN0QyxRQUFNLEVBQUVDLElBQUYsS0FBVyxPQUFNLHdCQUFhQyxlQUFLQyxJQUFMLENBQVVILEdBQVYsRUFBZSxjQUFmLENBQWIsQ0FBTixLQUFzRCxFQUF2RTs7QUFFQTtBQUNBLFNBQU9DLFNBQVMscUJBQVQsSUFBa0NBLFNBQVMsbUJBQWxEO0FBQ0Q7O0FBRU0sZUFBZWpCLGtCQUFmLENBQWtDZ0IsTUFBTUksUUFBUUMsR0FBUixFQUF4QyxFQUF1RCxFQUFFQyxjQUFjLElBQWhCLEtBQXlCLEVBQWhGLEVBQW9GO0FBQ3pGLE1BQUksTUFBTVAsb0JBQW9CQyxHQUFwQixDQUFWLEVBQW9DO0FBQ2xDLFdBQU9BLEdBQVA7QUFDRDs7QUFFRCxRQUFNTyxZ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aEQsV0FBdkIsRUFBb0NQLGVBQUtDLElBQUwsQ0FBVStDLGFBQVYsRUFBeUIsS0FBekIsQ0FBcEMsQ0FBTjtBQUNBLFFBQU10RCxJQUFJOEQscUJBQUosQ0FBMEJqRCxXQUExQixDQUFOO0FBQ0EsUUFBTWIsSUFBSWtDLE9BQUosQ0FBWXJCLFdBQVosQ0FBTjtBQUNEIiwiZmlsZSI6InBsYXRmb3JtLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHVybCBmcm9tICd1cmwnO1xyXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcclxuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcclxuaW1wb3J0IHJlcGxhY2UgZnJvbSAncmVwbGFjZS1pbi1maWxlJztcclxuaW1wb3J0ICogYXMgYXBwTWFuYWdlciBmcm9tICcuLi9jbGllbnRzL2FwcC1tYW5hZ2VyJztcclxuaW1wb3J0ICogYXMgYXV0aFNlcnZpY2UgZnJvbSAnLi4vY2xpZW50cy9hdXRoLXNlcnZpY2UnO1xyXG5pbXBvcnQgZGVjb21wcmVzc1VyaSBmcm9tICcuL2RlY29tcHJlc3MnO1xyXG5pbXBvcnQgY2xpVXJscyBmcm9tICcuLi8uLi9jb25maWcvc2VydmljZXMnO1xyXG5pbXBvcnQgeyB3cml0ZUpzb25GaWxlfSBmcm9tICcuL2RhdGEnO1xyXG5pbXBvcnQgKiBhcyBucG0gZnJvbSAnLi9ucG0nO1xyXG5pbXBvcnQgeyBlbnN1cmVZYXJuSW5zdGFsbGVkIH0gZnJvbSAnLi95YXJuJztcclxuaW1wb3J0ICogYXMgcmVhY3ROYXRpdmUgZnJvbSAnLi9yZWFjdC1uYXRpdmUnO1xyXG5pbXBvcnQgKiBhcyBhbmFseXRpY3MgZnJvbSAnLi9hbmFseXRpY3MnO1xyXG5pbXBvcnQgeyBwYXRoRXhpc3RzLCByZWFkSnNvbiwgcmVhZEZpbGUsIHdyaXRlRmlsZSB9IGZyb20gJ2ZzLWV4dHJhJztcclxuaW1wb3J0IGNvbW1hbmRFeGlzdHMgZnJvbSAnLi9jb21tYW5kLWV4aXN0cyc7XHJcbmltcG9ydCB7cmVhZEpzb25GaWxlfSBmcm9tIFwiLi9kYXRhXCI7XHJcblxyXG5hc3luYyBmdW5jdGlvbiBpc1BsYXRmb3JtRGlyZWN0b3J5KGRpcikge1xyXG4gIGNvbnN0IHsgbmFtZSB9ID0gYXdhaXQgcmVhZEpzb25GaWxlKHBhdGguam9pbihkaXIsICdwYWNrYWdlLmpzb24nKSkgfHwge307XHJcblxyXG4gIC8vIHBsYXRmb3JtIHBhY2thZ2Ugd2FzIHJlbmFtZWQgd2l0aCBQbGF0Zm9ybSByZWxlYXNlIHYxLjEuMTBcclxuICByZXR1cm4gbmFtZSA9PT0gJ0BzaG91dGVtL21vYmlsZS1hcHAnIHx8IG5hbWUgPT09ICdAc2hvdXRlbS9wbGF0Zm9ybSc7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRQbGF0Zm9ybVJvb3REaXIoZGlyID0gcHJvY2Vzcy5jd2QoKSwgeyBzaG91bGRUaHJvdyA9IHRydWUgfSA9IHt9KSB7XHJcbiAgaWYgKGF3YWl0IGlzUGxhdGZvcm1EaXJlY3RvcnkoZGlyKSkge1xyXG4gICAgcmV0dXJuIGRpcjtcclxuICB9XHJcblxyXG4gIGNvbnN0IHBhcmVudERpciA9IHBhdGguam9pbihkaXIsICcuLicpO1xyXG5cclxuICBpZiAocGFyZW50RGlyID09PSBkaXIpIHtcclxuICAgIGlmIChzaG91bGRUaHJvdykge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBhIHBsYXRmb3JtIGRpcmVjdG9yeScpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHJldHVybiBhd2FpdCBnZXRQbGF0Zm9ybVJvb3REaXIocGFyZW50RGlyLCB7IHNob3VsZFRocm93IH0pO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0UGxhdGZvcm1FeHRlbnNpb25zRGlyKGRpciA9IG51bGwpIHtcclxuICByZXR1cm4gcGF0aC5qb2luKGRpciB8fCBhd2FpdCBnZXRQbGF0Zm9ybVJvb3REaXIoKSwgJ2V4dGVuc2lvbnMnKTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVBsYXRmb3JtQ29uZmlnKHBsYXRmb3JtRGlyLCBvcHRzKSB7XHJcbiAgY29uc3QgY29uZmlnVGVtcGxhdGUgPSBhd2FpdCByZWFkSnNvbihwYXRoLmpvaW4ocGxhdGZvcm1EaXIsICdjb25maWcudGVtcGxhdGUuanNvbicpKTtcclxuXHJcbiAgbGV0IGF1dGhvcml6YXRpb247XHJcbiAgdHJ5IHtcclxuICAgIGF1dGhvcml6YXRpb24gPSBhd2FpdCBhdXRoU2VydmljZS5jcmVhdGVBcHBBY2Nlc3NUb2tlbihvcHRzLmFwcElkLCBhd2FpdCBhdXRoU2VydmljZS5nZXRSZWZyZXNoVG9rZW4oKSk7XHJcbiAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICBpZiAoZXJyLmNvZGUgPT09IDQwMSB8fCBlcnIuY29kZSA9PT0gNDAzKSB7XHJcbiAgICAgIGVyci5tZXNzYWdlID0gJ05vdCBhdXRob3JpemVkIHRvIGNyZWF0ZSBhcHBsaWNhdGlvbiB0b2tlbi4gWW91IG11c3QgbG9nIGluIGFnYWluIHVzaW5nIGBzaG91dGVtIGxvZ2luYCBjb21tYW5kLic7XHJcbiAgICB9XHJcbiAgICB0aHJvdyBlcnI7XHJcbiAgfVxyXG5cclxuICByZXR1cm4ge1xyXG4gICAgLi4uY29uZmlnVGVtcGxhdGUsXHJcbiAgICAuLi5vcHRzLFxyXG4gICAgc2VydmVyQXBpRW5kcG9pbnQ6IHVybC5wYXJzZShjbGlVcmxzLmFwcE1hbmFnZXIpLmhvc3RuYW1lLFxyXG4gICAgbGVnYWN5QXBpRW5kcG9pbnQ6IHVybC5wYXJzZShjbGlVcmxzLmxlZ2FjeVNlcnZpY2UpLmhvc3RuYW1lLFxyXG4gICAgYXV0aG9yaXphdGlvbixcclxuICAgIGNvbmZpZ3VyYXRpb25GaWxlUGF0aDogJ2NvbmZpZy5qc29uJ1xyXG4gIH07XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRQbGF0Zm9ybUNvbmZpZyhwbGF0Zm9ybURpciA9IG51bGwpIHtcclxuICByZXR1cm4gYXdhaXQgcmVhZEpzb24ocGF0aC5qb2luKHBsYXRmb3JtRGlyIHx8IGF3YWl0IGdldFBsYXRmb3JtUm9vdERpcigpLCAnY29uZmlnLmpzb24nKSk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzZXRQbGF0Zm9ybUNvbmZpZyhwbGF0Zm9ybURpciwgbW9iaWxlQ29uZmlnKSB7XHJcbiAgYXdhaXQgd3JpdGVKc29uRmlsZShtb2JpbGVDb25maWcsIHBhdGguam9pbihwbGF0Zm9ybURpciwgJ2NvbmZpZy5qc29uJykpO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY29uZmlndXJlUGxhdGZvcm0ocGxhdGZvcm1EaXIpIHtcclxuICBhd2FpdCBlbnN1cmVZYXJuSW5zdGFsbGVkKCk7XHJcbiAgYXdhaXQgcmVhY3ROYXRpdmUuZW5zdXJlSW5zdGFsbGVkKCk7XHJcbiAgaWYgKHByb2Nlc3MucGxhdGZvcm0gPT09ICdkYXJ3aW4nICYmICFhd2FpdCBjb21tYW5kRXhpc3RzKCdwb2QnKSkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdNaXNzaW5nIGBwb2RzYCBjb21tYW5kLiBQbGVhc2UgaW5zdGFsbCBjb2NvYXBvZHMgYW5kIHJ1biBgc2hvdXRlbSBjb25maWd1cmVgIGluIHRoZSAnICtcclxuICAgICAgYCR7cGxhdGZvcm1EaXJ9IGRpcmVjdG9yeWApO1xyXG4gIH1cclxuXHJcbiAgaWYgKCFhd2FpdCBnZXRQbGF0Zm9ybUNvbmZpZyhwbGF0Zm9ybURpcikpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignTWlzc2luZyBjb25maWcuanNvbiBmaWxlJyk7XHJcbiAgfVxyXG5cclxuICBhd2FpdCBucG0uaW5zdGFsbChwYXRoLmpvaW4ocGxhdGZvcm1EaXIsICdzY3JpcHRzJykpO1xyXG4gIGF3YWl0IG5wbS5ydW4ocGxhdGZvcm1EaXIsICdjb25maWd1cmUnKTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZpeFBsYXRmb3JtKHBsYXRmb3JtRGlyLCBhcHBJZCkge1xyXG4gIGNvbnN0IGFwcEJ1aWxkZXJQYXRoID0gcGF0aC5qb2luKHBsYXRmb3JtRGlyLCAnc2NyaXB0cycsICdjbGFzc2VzJywgJ2FwcC1idWlsZGVyLmpzJyk7XHJcblxyXG4gIGlmIChwcm9jZXNzLnBsYXRmb3JtID09PSAnd2luMzInKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICBhd2FpdCByZXBsYWNlKHtcclxuICAgICAgICBmaWxlczogYXBwQnVpbGRlclBhdGgsXHJcbiAgICAgICAgZnJvbTogJy4vZ3JhZGxldycsXHJcbiAgICAgICAgdG86ICdncmFkbGV3J1xyXG4gICAgICB9KTtcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICBjb25zb2xlLmxvZygnV0FSTjogQ291bGQgbm90IHJlbmFtZSAuL2dyYWRsZSB0byBncmFkbGUnKTtcclxuICAgIH1cclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBhd2FpdCByZXBsYWNlKHtcclxuICAgICAgICBmaWxlczogYXBwQnVpbGRlclBhdGgsXHJcbiAgICAgICAgZnJvbTogXCJjb25zdCBhcGtQYXRoID0gcGF0aC5qb2luKCdhbmRyb2lkJywgJ2FwcCcsICdidWlsZCcsICdvdXRwdXRzJywgJ2FwaycpO1wiLFxyXG4gICAgICAgIHRvOiBgY29uc3QgYXBrUGF0aCA9IHBhdGguam9pbignYzovJywgJyR7YXBwSWR9JywgJ3RtcCcsICdTaG91dGVtQXBwJywgJ2FwcCcsICdvdXRwdXRzJywgJ2FwaycpO2BcclxuICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgY29uc29sZS5sb2coJ1dBUk46IENvdWxkIG5vdCBhZGFwdCBjbGllbnQgZm9yIGM6XFxcXHRtcCBidWlsZCBkaXJlY3RvcnknKTtcclxuICAgIH1cclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBhd2FpdCByZXBsYWNlKHtcclxuICAgICAgICBmaWxlczogcGF0aC5qb2luKHBsYXRmb3JtRGlyLCAnYW5kcm9pZCcsICdidWlsZC5ncmFkbGUnKSxcclxuICAgICAgICBmcm9tOiAnLy88Q0xJPiBidWlsZERpciA9IFwiQzovdG1wLycsXHJcbiAgICAgICAgdG86IGBidWlsZERpciA9IFwiQzovdG1wLyR7YXBwSWR9L2BcclxuICAgICAgfSlcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICBjb25zb2xlLmxvZygnV0FSTjogQ291bGQgbm90IHNldCB0aGUgdG1wIGJ1aWxkIGRpcmVjdG9yeSBmb3IgYW5kcm9pZCBhcHAnKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkb3dubG9hZEFwcChhcHBJZCwgZGVzdGluYXRpb25EaXIsIG9wdGlvbnMgPSB7fSkge1xyXG4gIGFuYWx5dGljcy5zZXRBcHBJZChhcHBJZCk7XHJcblxyXG4gIGNvbnN0IHZlcnNpb25DaGVjayA9IG9wdGlvbnMudmVyc2lvbkNoZWNrIHx8ICgoKSA9PiB7fSk7XHJcblxyXG4gIGNvbnN0IHsgbW9iaWxlQXBwVmVyc2lvbiB9ID0gYXdhaXQgYXBwTWFuYWdlci5nZXRBcHBsaWNhdGlvblBsYXRmb3JtKGFwcElkKTtcclxuICBhd2FpdCB2ZXJzaW9uQ2hlY2sobW9iaWxlQXBwVmVyc2lvbik7XHJcblxyXG4gIGF3YWl0IHB1bGxQbGF0Zm9ybShtb2JpbGVBcHBWZXJzaW9uLCBkZXN0aW5hdGlvbkRpciwgb3B0aW9ucyk7XHJcblxyXG4gIGlmICghYXdhaXQgcGF0aEV4aXN0cyhkZXN0aW5hdGlvbkRpcikpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignUGxhdGZvcm0gY29kZSBjb3VsZCBub3QgYmUgZG93bmxvYWRlZCBmcm9tIGdpdGh1Yi4gTWFrZSBzdXJlIHRoYXQgcGxhdGZvcm0gaXMgc2V0dXAgY29ycmVjdGx5LicpO1xyXG4gIH1cclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gcHVsbFBsYXRmb3JtKHZlcnNpb24sIGRlc3RpbmF0aW9uLCBvcHRpb25zKSB7XHJcbiAgY29uc3QgdXJsID0gYCR7Y2xpVXJscy5tb2JpbGVBcHBVcmx9L2FyY2hpdmUvdiR7dmVyc2lvbn0udGFyLmd6YDtcclxuICBhd2FpdCBkZWNvbXByZXNzVXJpKHVybCwgZGVzdGluYXRpb24sIHsgLi4ub3B0aW9ucywgc3RyaXA6IDEsIHVzZUNhY2hlOiBvcHRpb25zLnVzZUNhY2hlIH0pO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYWRkVG9FeHRlbnNpb25zSnMocGxhdGZvcm1EaXIsIGV4dGVuc2lvblBhdGgpIHtcclxuICBjb25zdCB7IG5hbWUgfSA9IGF3YWl0IG5wbS5nZXRQYWNrYWdlSnNvbihwYXRoLmpvaW4oZXh0ZW5zaW9uUGF0aCwgJ2FwcCcpKTtcclxuXHJcbiAgY29uc3QgZXh0ZW5zaW9uc0pzUGF0aCA9IHBhdGguam9pbihwbGF0Zm9ybURpciwgJ2V4dGVuc2lvbnMuanMnKTtcclxuXHJcbiAgbGV0IGV4dGVuc2lvbnNKc0RhdGEgPSBhd2FpdCByZWFkRmlsZShleHRlbnNpb25zSnNQYXRoLCAndXRmOCcpO1xyXG5cclxuICBpZiAoXy5pbmNsdWRlcyhleHRlbnNpb25zSnNEYXRhLCBgJyR7bmFtZX0nYCkpIHtcclxuICAgIHJldHVybjtcclxuICB9XHJcblxyXG4gIGV4dGVuc2lvbnNKc0RhdGEgPSBleHRlbnNpb25zSnNEYXRhLnJlcGxhY2UoJ307JywgYCcke25hbWV9JzogcmVxdWlyZSgnJHtuYW1lfScpLGApO1xyXG4gIGV4dGVuc2lvbnNKc0RhdGEgKz0gJyAgfTtcXG4nO1xyXG5cclxuICBhd2FpdCB3cml0ZUZpbGUoZXh0ZW5zaW9uc0pzUGF0aCwgZXh0ZW5zaW9uc0pzRGF0YSk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsaW5rTG9jYWxFeHRlbnNpb24ocGxhdGZvcm1EaXIsIGV4dGVuc2lvblBhdGgpIHtcclxuICBhd2FpdCBucG0uYWRkTG9jYWxEZXBlbmRlbmN5KHBsYXRmb3JtRGlyLCBwYXRoLmpvaW4oZXh0ZW5zaW9uUGF0aCwgJ2FwcCcpKTtcclxuICBhd2FpdCBucG0ubGlua0xvY2FsRGVwZW5kZW5jaWVzKHBsYXRmb3JtRGlyKTtcclxuICBhd2FpdCBucG0uaW5zdGFsbChwbGF0Zm9ybURpcik7XHJcbn1cclxuIl19