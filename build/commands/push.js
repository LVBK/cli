'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.uploadExtension = uploadExtension;
exports.promptPublishableVersion = promptPublishableVersion;

var _fsExtra = require('fs-extra');

var _fsExtra2 = _interopRequireDefault(_fsExtra);

var _extensionManager = require('../clients/extension-manager');

var extensionManager = _interopRequireWildcard(_extensionManager);

var _serverEnv = require('../clients/server-env');

var _localExtensions = require('../clients/local-extensions');

var local = _interopRequireWildcard(_localExtensions);

var _extension = require('../services/extension');

var _packer = require('../services/packer');

var _packer2 = _interopRequireDefault(_packer);

var _user_messages = require('../user_messages');

var _user_messages2 = _interopRequireDefault(_user_messages);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _progressBar = require('../services/progress-bar');

var _spinner = require('../services/spinner');

var _extlint = require('../services/extlint');

var _extlint2 = _interopRequireDefault(_extlint);

var _login = require('./login');

var _inquirer = require('inquirer');

var _semver = require('semver');

var _semver2 = _interopRequireDefault(_semver);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

async function uploadExtension(opts = {}, extensionDir = (0, _extension.ensureInExtensionDir)()) {
  if (!opts.nocheck) {
    process.stdout.write('Checking the extension code for syntax errors... ');
    try {
      await (0, _extlint2.default)(extensionDir);
      console.log(`[${'OK'.green.bold}]`);
    } catch (err) {
      err.message = 'Syntax errors detected, aborting push! Use `shoutem push --nocheck` to override';
      throw err;
    }
  }
  const extJson = await (0, _extension.loadExtensionJson)(extensionDir);
  if (opts.publish) {
    await promptPublishableVersion(extJson);
    await (0, _extension.saveExtensionJson)(extJson, extensionDir);
  }

  const packResult = await (0, _packer2.default)(extensionDir, { packToTempDir: true, nobuild: opts.nobuild });

  const { size } = await _fsExtra2.default.stat(packResult.package);
  const stream = _fsExtra2.default.createReadStream(packResult.package);

  const id = await local.getExtensionCanonicalName(extensionDir);

  let spinner = null;
  const extensionId = await extensionManager.uploadExtension(id, stream, (0, _progressBar.createProgressHandler)({ msg: 'Upload progress', total: size, onFinished: () => spinner = (0, _spinner.startSpinner)('Processing upload...') }), size);
  if (spinner) {
    spinner.stop(true);
    console.log(`Processing upload... [${'OK'.green.bold}]`);
  }
  console.log(_user_messages2.default.push.uploadingInfo(extJson, (0, _serverEnv.getHostEnvName)()) + ` [${'OK'.green.bold}]`);

  await _fsExtra2.default.unlink(packResult.package);

  const notPacked = _lodash2.default.difference(packResult.allDirs, packResult.packedDirs);
  if (notPacked.length > 0) {
    throw new Error(_user_messages2.default.push.missingPackageJson(notPacked));
  }

  return { extensionId, packResult, extJson };
}

async function promptPublishableVersion(extJson) {
  const dev = await (0, _login.ensureUserIsLoggedIn)();
  while (true) {
    const { name, version } = extJson;
    const canonical = (0, _extension.getExtensionCanonicalName)(dev.name, name, version);
    const canExtensionBePublished = await (0, _spinner.spinify)((0, _extensionManager.canPublish)(canonical), `Checking if version ${version} can be published`);
    if (canExtensionBePublished) {
      return;
    }
    const { newVersion } = await (0, _inquirer.prompt)({
      name: 'newVersion',
      default: _semver2.default.inc(version, 'patch'),
      message: `Version ${version} is already published. Specify another version:`,
      validate: v => !!_semver2.default.valid(v)
    });
    extJson.version = newVersion;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21tYW5kcy9wdXNoLmpzIl0sIm5hbWVzIjpbInVwbG9hZEV4dGVuc2lvbiIsInByb21wdFB1Ymxpc2hhYmxlVmVyc2lvbiIsImV4dGVuc2lvbk1hbmFnZXIiLCJsb2NhbCIsIm9wdHMiLCJleHRlbnNpb25EaXIiLCJub2NoZWNrIiwicHJvY2VzcyIsInN0ZG91dCIsIndyaXRlIiwiY29uc29sZSIsImxvZyIsImdyZWVuIiwiYm9sZCIsImVyciIsIm1lc3NhZ2UiLCJleHRKc29uIiwicHVibGlzaCIsInBhY2tSZXN1bHQiLCJwYWNrVG9UZW1wRGlyIiwibm9idWlsZCIsInNpemUiLCJmcyIsInN0YXQiLCJwYWNrYWdlIiwic3RyZWFtIiwiY3JlYXRlUmVhZFN0cmVhbSIsImlkIiwiZ2V0RXh0ZW5zaW9uQ2Fub25pY2FsTmFtZSIsInNwaW5uZXIiLCJleHRlbnNpb25JZCIsIm1zZyIsInRvdGFsIiwib25GaW5pc2hlZCIsInN0b3AiLCJwdXNoIiwidXBsb2FkaW5nSW5mbyIsInVubGluayIsIm5vdFBhY2tlZCIsIl8iLCJkaWZmZXJlbmNlIiwiYWxsRGlycyIsInBhY2tlZERpcnMiLCJsZW5ndGgiLCJFcnJvciIsIm1pc3NpbmdQYWNrYWdlSnNvbiIsImRldiIsIm5hbWUiLCJ2ZXJzaW9uIiwiY2Fub25pY2FsIiwiY2FuRXh0ZW5zaW9uQmVQdWJsaXNoZWQiLCJuZXdWZXJzaW9uIiwiZGVmYXVsdCIsInNlbXZlciIsImluYyIsInZhbGlkYXRlIiwidiIsInZhbGlkIl0sIm1hcHBpbmdzIjoiOzs7OztRQXFCc0JBLGUsR0FBQUEsZTtRQStDQUMsd0IsR0FBQUEsd0I7O0FBcEV0Qjs7OztBQUNBOztJQUFZQyxnQjs7QUFDWjs7QUFDQTs7SUFBWUMsSzs7QUFDWjs7QUFNQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUNBOztBQUVBOztBQUNBOzs7Ozs7OztBQUVPLGVBQWVILGVBQWYsQ0FBK0JJLE9BQU8sRUFB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TSxZQUQ0QjtBQUVsQ0ssZUFBU0MsaUJBQU9DLEdBQVAsQ0FBV04sT0FBWCxFQUFvQixPQUFwQixDQUZ5QjtBQUdsQ2pDLGVBQVUsV0FBVWlDLE9BQVEsaURBSE07QUFJbENPLGdCQUFVQyxLQUFLLENBQUMsQ0FBQ0gsaUJBQU9JLEtBQVAsQ0FBYUQsQ0FBYjtBQUppQixLQUFQLENBQTdCO0FBTUF4QyxZQUFRZ0MsT0FBUixHQUFrQkcsVUFBbEI7QUFDRDtBQUNGIiwiZmlsZSI6InB1c2guanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xyXG5pbXBvcnQgKiBhcyBleHRlbnNpb25NYW5hZ2VyIGZyb20gJy4uL2NsaWVudHMvZXh0ZW5zaW9uLW1hbmFnZXInO1xyXG5pbXBvcnQge2dldEhvc3RFbnZOYW1lfSBmcm9tICcuLi9jbGllbnRzL3NlcnZlci1lbnYnO1xyXG5pbXBvcnQgKiBhcyBsb2NhbCBmcm9tICcuLi9jbGllbnRzL2xvY2FsLWV4dGVuc2lvbnMnO1xyXG5pbXBvcnQge1xyXG4gIGVuc3VyZUluRXh0ZW5zaW9uRGlyLFxyXG4gIGdldEV4dGVuc2lvbkNhbm9uaWNhbE5hbWUsXHJcbiAgbG9hZEV4dGVuc2lvbkpzb24sXHJcbiAgc2F2ZUV4dGVuc2lvbkpzb25cclxufSBmcm9tICcuLi9zZXJ2aWNlcy9leHRlbnNpb24nO1xyXG5pbXBvcnQgc2hvdXRlbVBhY2sgZnJvbSAnLi4vc2VydmljZXMvcGFja2VyJztcclxuaW1wb3J0IG1zZyBmcm9tICcuLi91c2VyX21lc3NhZ2VzJztcclxuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcclxuaW1wb3J0IHtjcmVhdGVQcm9ncmVzc0hhbmRsZXJ9IGZyb20gJy4uL3NlcnZpY2VzL3Byb2dyZXNzLWJhcic7XHJcbmltcG9ydCB7c3BpbmlmeSwgc3RhcnRTcGlubmVyfSBmcm9tICcuLi9zZXJ2aWNlcy9zcGlubmVyJztcclxuaW1wb3J0IGV4dExpbnQgZnJvbSAnLi4vc2VydmljZXMvZXh0bGludCc7XHJcbmltcG9ydCB7ZW5zdXJlVXNlcklzTG9nZ2VkSW59IGZyb20gXCIuL2xvZ2luXCI7XHJcbmltcG9ydCB7Y2FuUHVibGlzaH0gZnJvbSBcIi4uL2NsaWVudHMvZXh0ZW5zaW9uLW1hbmFnZXJcIjtcclxuaW1wb3J0IHsgcHJvbXB0IH0gZnJvbSAnaW5xdWlyZXInO1xyXG5pbXBvcnQgc2VtdmVyIGZyb20gJ3NlbXZlcic7XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBsb2FkRXh0ZW5zaW9uKG9wdHMgPSB7fSwgZXh0ZW5zaW9uRGlyID0gZW5zdXJlSW5FeHRlbnNpb25EaXIoKSkge1xyXG4gIGlmICghb3B0cy5ub2NoZWNrKSB7XHJcbiAgICBwcm9jZXNzLnN0ZG91dC53cml0ZSgnQ2hlY2tpbmcgdGhlIGV4dGVuc2lvbiBjb2RlIGZvciBzeW50YXggZXJyb3JzLi4uICcpO1xyXG4gICAgdHJ5IHtcclxuICAgICAgYXdhaXQgZXh0TGludChleHRlbnNpb25EaXIpO1xyXG4gICAgICBjb25zb2xlLmxvZyhgWyR7J09LJy5ncmVlbi5ib2xkfV1gKTtcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICBlcnIubWVzc2FnZSA9ICdTeW50YXggZXJyb3JzIGRldGVjdGVkLCBhYm9ydGluZyBwdXNoISBVc2UgYHNob3V0ZW0gcHVzaCAtLW5vY2hlY2tgIHRvIG92ZXJyaWRlJztcclxuICAgICAgdGhyb3cgZXJyO1xyXG4gICAgfVxyXG4gIH1cclxuICBjb25zdCBleHRKc29uID0gYXdhaXQgbG9hZEV4dGVuc2lvbkpzb24oZXh0ZW5zaW9uRGlyKTtcclxuICBpZiAob3B0cy5wdWJsaXNoKSB7XHJcbiAgICBhd2FpdCBwcm9tcHRQdWJsaXNoYWJsZVZlcnNpb24oZXh0SnNvbik7XHJcbiAgICBhd2FpdCBzYXZlRXh0ZW5zaW9uSnNvbihleHRKc29uLCBleHRlbnNpb25EaXIpO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgcGFja1Jlc3VsdCA9IGF3YWl0IHNob3V0ZW1QYWNrKGV4dGVuc2lvbkRpciwgeyBwYWNrVG9UZW1wRGlyOiB0cnVlLCBub2J1aWxkOiBvcHRzLm5vYnVpbGQgfSk7XHJcblxyXG4gIGNvbnN0IHsgc2l6ZSB9ID0gYXdhaXQgZnMuc3RhdChwYWNrUmVzdWx0LnBhY2thZ2UpO1xyXG4gIGNvbnN0IHN0cmVhbSA9IGZzLmNyZWF0ZVJlYWRTdHJlYW0ocGFja1Jlc3VsdC5wYWNrYWdlKTtcclxuXHJcbiAgY29uc3QgaWQgPSBhd2FpdCBsb2NhbC5nZXRFeHRlbnNpb25DYW5vbmljYWxOYW1lKGV4dGVuc2lvbkRpcik7XHJcblxyXG4gIGxldCBzcGlubmVyID0gbnVsbDtcclxuICBjb25zdCBleHRlbnNpb25JZCA9IGF3YWl0IGV4dGVuc2lvbk1hbmFnZXIudXBsb2FkRXh0ZW5zaW9uKFxyXG4gICAgaWQsXHJcbiAgICBzdHJlYW0sXHJcbiAgICBjcmVhdGVQcm9ncmVzc0hhbmRsZXIoeyBtc2c6ICdVcGxvYWQgcHJvZ3Jlc3MnLCB0b3RhbDogc2l6ZSwgb25GaW5pc2hlZDogKCkgPT4gc3Bpbm5lciA9IHN0YXJ0U3Bpbm5lcignUHJvY2Vzc2luZyB1cGxvYWQuLi4nKSB9KSxcclxuICAgIHNpemVcclxuICApO1xyXG4gIGlmIChzcGlubmVyKSB7XHJcbiAgICBzcGlubmVyLnN0b3AodHJ1ZSk7XHJcbiAgICBjb25zb2xlLmxvZyhgUHJvY2Vzc2luZyB1cGxvYWQuLi4gWyR7J09LJy5ncmVlbi5ib2xkfV1gKTtcclxuICB9XHJcbiAgY29uc29sZS5sb2cobXNnLnB1c2gudXBsb2FkaW5nSW5mbyhleHRKc29uLCBnZXRIb3N0RW52TmFtZSgpKSArIGAgWyR7J09LJy5ncmVlbi5ib2xkfV1gKTtcclxuXHJcbiAgYXdhaXQgZnMudW5saW5rKHBhY2tSZXN1bHQucGFja2FnZSk7XHJcblxyXG4gIGNvbnN0IG5vdFBhY2tlZCA9IF8uZGlmZmVyZW5jZShwYWNrUmVzdWx0LmFsbERpcnMsIHBhY2tSZXN1bHQucGFja2VkRGlycyk7XHJcbiAgaWYgKG5vdFBhY2tlZC5sZW5ndGggPiAwKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IobXNnLnB1c2gubWlzc2luZ1BhY2thZ2VKc29uKG5vdFBhY2tlZCkpO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHsgZXh0ZW5zaW9uSWQsIHBhY2tSZXN1bHQsIGV4dEpzb24gfTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHByb21wdFB1Ymxpc2hhYmxlVmVyc2lvbihleHRKc29uKSB7XHJcbiAgY29uc3QgZGV2ID0gYXdhaXQgZW5zdXJlVXNlcklzTG9nZ2VkSW4oKTtcclxuICB3aGlsZSAodHJ1ZSkge1xyXG4gICAgY29uc3QgeyBuYW1lLCB2ZXJzaW9uIH0gPSBleHRKc29uO1xyXG4gICAgY29uc3QgY2Fub25pY2FsID0gZ2V0RXh0ZW5zaW9uQ2Fub25pY2FsTmFtZShkZXYubmFtZSwgbmFtZSwgdmVyc2lvbik7XHJcbiAgICBjb25zdCBjYW5FeHRlbnNpb25CZVB1Ymxpc2hlZCA9IGF3YWl0IHNwaW5pZnkoY2FuUHVibGlzaChjYW5vbmljYWwpLCBgQ2hlY2tpbmcgaWYgdmVyc2lvbiAke3ZlcnNpb259IGNhbiBiZSBwdWJsaXNoZWRgKTtcclxuICAgIGlmIChjYW5FeHRlbnNpb25CZVB1Ymxpc2hlZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCB7IG5ld1ZlcnNpb24gfSA9IGF3YWl0IHByb21wdCh7XHJcbiAgICAgIG5hbWU6ICduZXdWZXJzaW9uJyxcclxuICAgICAgZGVmYXVsdDogc2VtdmVyLmluYyh2ZXJzaW9uLCAncGF0Y2gnKSxcclxuICAgICAgbWVzc2FnZTogYFZlcnNpb24gJHt2ZXJzaW9ufSBpcyBhbHJlYWR5IHB1Ymxpc2hlZC4gU3BlY2lmeSBhbm90aGVyIHZlcnNpb246YCxcclxuICAgICAgdmFsaWRhdGU6IHYgPT4gISFzZW12ZXIudmFsaWQodiksXHJcbiAgICB9KTtcclxuICAgIGV4dEpzb24udmVyc2lvbiA9IG5ld1ZlcnNpb247XHJcbiAgfVxyXG59XHJcbiJdfQ==